<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meilin Starwell | Character Companion</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Uncial+Antiqua&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Redacted+Script:wght@400&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Styles (Modular CSS) -->
    <link rel="stylesheet" href="css/main.css">
    <!-- Legacy styles for sections not yet migrated -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Mobile Header (visible on small screens) -->
    <header class="mobile-header" id="mobile-header">
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Open menu">
            <i data-lucide="menu"></i>
        </button>
        <h1 class="mobile-title">Meilin Starwell</h1>
    </header>

    <!-- Drawer Overlay (for closing mobile menu) -->
    <div class="drawer-overlay" id="drawer-overlay"></div>

    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-portrait" data-lightbox="img/portrait.png">
                    <img src="img/portrait.png" alt="Meilin Starwell" />
                </div>
                <h1 class="sidebar-title">Meilin Starwell</h1>
                <p class="sidebar-subtitle">Dockside Apothecary</p>
            </div>
            <nav class="sidebar-nav">
                <a href="#overview" class="nav-link" data-page="overview">
                    <span class="nav-icon"><i data-lucide="user"></i></span>
                    <span class="nav-text">Character Overview</span>
                </a>
                <a href="#rumors" class="nav-link active" data-page="rumors">
                    <span class="nav-icon"><i data-lucide="speech"></i></span>
                    <span class="nav-text">Rumors</span>
                </a>
                <a href="#backstory" class="nav-link" data-page="backstory">
                    <span class="nav-icon"><i data-lucide="book-open"></i></span>
                    <span class="nav-text">Backstory</span>
                </a>
                <a href="#dmtools" class="nav-link" data-page="dmtools">
                    <span class="nav-icon"><i data-lucide="dices"></i></span>
                    <span class="nav-text">DM Tools</span>
                </a>
                <a href="#medicine" class="nav-link" data-page="medicine">
                    <span class="nav-icon"><i data-lucide="leaf"></i></span>
                    <span class="nav-text">Herbal Medicine</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <p class="sidebar-quote">If it matters, write it down.</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="main-area">
            <!-- At a Glance Page (DM Quick Reference) -->
            <div class="page" id="overview-page">
                <!-- Hero Section -->
                <section class="aag-hero" style="background-image: url('img/banner.png');" data-lightbox="img/banner.png" title="Click to view full image">
                    <div class="aag-hero-content">
                        <h1 class="aag-name" id="aag-name">Meilin Starwell</h1>
                        <p class="aag-tagline" id="aag-tagline"></p>
                        <blockquote class="aag-quote" id="aag-quote"></blockquote>
                    </div>
                </section>

                <!-- Core Concept Section -->
                <section class="aag-section aag-core">
                    <div class="aag-thesis-box" id="aag-thesis"></div>
                    <div class="aag-core-details">
                        <div class="aag-detail" id="aag-trouble">
                            <span class="aag-detail-label">Trouble:</span>
                            <span class="aag-detail-text"></span>
                        </div>
                        <div class="aag-detail" id="aag-defining">
                            <span class="aag-detail-label">Defining Moment:</span>
                            <span class="aag-detail-text"></span>
                        </div>
                    </div>
                </section>

                <!-- 30-Second Summary -->
                <section class="aag-section aag-summary">
                    <h2 class="aag-section-title">The Story</h2>
                    <p class="aag-summary-text" id="aag-summary"></p>
                </section>

                <!-- Cards Row: Drives, Boundaries, Shared Anchor -->
                <section class="aag-section aag-cards-row">
                    <div class="aag-card aag-drives">
                        <h3 class="aag-card-title">Drives</h3>
                        <ul class="aag-card-list" id="aag-drives-list"></ul>
                    </div>
                    <div class="aag-card aag-boundaries">
                        <h3 class="aag-card-title">Boundaries</h3>
                        <ul class="aag-card-list" id="aag-boundaries-list"></ul>
                    </div>
                    <div class="aag-card aag-glue">
                        <h3 class="aag-card-title">Shared Anchor</h3>
                        <ul class="aag-card-list" id="aag-glue-list"></ul>
                    </div>
                </section>

                <!-- Secrets Section -->
                <section class="aag-section aag-secrets">
                    <h2 class="aag-section-title">Secrets &amp; Mysteries</h2>
                    <div class="aag-secrets-grid" id="aag-secrets-grid"></div>
                </section>

                <!-- Quick Links -->
                <section class="aag-section aag-quicklinks">
                    <h2 class="aag-section-title">Explore More</h2>
                    <div class="aag-links-row">
                        <a href="#backstory" class="aag-link-card" data-navigate="backstory">
                            <span class="aag-link-icon"><i data-lucide="book-open"></i></span>
                            <span class="aag-link-title">Backstory</span>
                            <span class="aag-link-count" id="aag-chapters-count">12 chapters</span>
                            <span class="click-hint"><i data-lucide="info"></i></span>
                        </a>
                        <a href="#dmtools" class="aag-link-card" data-navigate="dmtools" data-section="relationships">
                            <span class="aag-link-icon"><i data-lucide="link"></i></span>
                            <span class="aag-link-title">Relationships</span>
                            <span class="aag-link-count" id="aag-relationships-count">8 connections</span>
                            <span class="click-hint"><i data-lucide="info"></i></span>
                        </a>
                        <a href="#dmtools" class="aag-link-card" data-navigate="dmtools" data-section="knives">
                            <span class="aag-link-icon"><i data-lucide="sword"></i></span>
                            <span class="aag-link-title">Knives</span>
                            <span class="aag-link-count" id="aag-knives-count">5 hooks for the DM</span>
                            <span class="click-hint"><i data-lucide="info"></i></span>
                        </a>
                    </div>
                </section>
            </div>

            <!-- Rumors Page (Player-Facing) -->
            <div class="page active" id="rumors-page">
                <!-- Hero with Key Art -->
                <header class="rumors-hero">
                    <img src="img/key_art.png" alt="Meilin Starwell" class="rumors-hero-image" />
                </header>

                <!-- Divider -->
                <hr class="rumors-divider" />

                <!-- Section Title -->
                <h2 class="rumors-section-title">What They Say</h2>
                <p class="rumors-hint"><em>Hover to reveal what they whisper...</em></p>

                <!-- Main Rumors Layout -->
                <div class="rumors-layout">
                    <!-- Rumors Sidebar -->
                    <aside class="rumors-sidebar">
                        <div class="rumors-list" id="rumors-list">
                            <!-- Populated by JS -->
                        </div>
                    </aside>

                    <!-- Character Gallery -->
                    <main class="rumors-gallery">
                        <div class="rumors-gallery-single" id="rumors-gallery-container" data-lightbox="img/scene.png">
                            <img class="rumors-gallery-image" id="rumors-gallery-image-a" src="img/scene.png" alt="Meilin at work" />
                            <img class="rumors-gallery-image rumors-gallery-image--hidden" id="rumors-gallery-image-b" src="img/scene.png" alt="Meilin at work" />
                        </div>
                    </main>
                </div>

                <!-- Divider -->
                <hr class="rumors-divider" />

                <!-- Visual Details -->
                <section class="rumors-details">
                    <h2 class="rumors-details-title">What You Notice</h2>
                    <p class="rumors-details-hint"><em>Hover to illuminate the details...</em></p>
                    <div class="rumors-details-grid">
                        <div class="rumors-detail-card">
                            <span class="rumors-detail-icon"><i data-lucide="eye"></i></span>
                            <h3>The Look</h3>
                            <p>Waxed-canvas cloak, labeled vials, small notebook, satchel strapped down tight.</p>
                        </div>
                        <div class="rumors-detail-card">
                            <span class="rumors-detail-icon"><i data-lucide="hand"></i></span>
                            <h3>The Hands</h3>
                            <p>Ink-stained fingers that never quite wash clean. Work-worn, chemical-burn marks like a constellation.</p>
                        </div>
                        <div class="rumors-detail-card">
                            <span class="rumors-detail-icon"><i data-lucide="book-open-text"></i></span>
                            <h3>The Read</h3>
                            <p>Kind, but watchful. You get the sense she's already figured you out.</p>
                        </div>
                    </div>
                </section>

                <!-- Divider -->
                <hr class="rumors-divider" />

                <!-- Character Turnaround with Interactive Hotspots -->
                <section class="rumors-views">
                    <h2 class="turnaround-title">Character Design</h2>
                    <p class="turnaround-hint"><em>Hover over the glowing points to explore details...</em></p>
                    <div class="rumors-turnaround" id="turnaround-container">
                        <img src="img/turnaround.png" alt="Meilin Starwell - Character Turnaround" data-lightbox="img/turnaround.png" />
                        
                        <!-- Interactive Hotspots -->
                        <div class="hotspot" data-hotspot="potion-vials" style="left: 40%; top: 44%;">
                            <span class="hotspot-pulse"></span>
                            <div class="hotspot-tooltip">
                                <h4>Potion Vials</h4>
                                <p>Glass vials filled with prepared remedies: antitoxins, stimulants, and numbing agents. Each color-coded by effect.</p>
                            </div>
                        </div>
                        
                        <div class="hotspot" data-hotspot="satchel" style="left: 8%; top: 49%;">
                            <span class="hotspot-pulse"></span>
                            <div class="hotspot-tooltip">
                                <h4>Herbalist's Satchel</h4>
                                <p>A reinforced leather pouch containing mortar, pestle, and dried ingredients. The buckles are worn smooth from years of use.</p>
                            </div>
                        </div>
                        
                        <div class="hotspot" data-hotspot="cape" style="left: 82%; top: 29%;">
                            <span class="hotspot-pulse"></span>
                            <div class="hotspot-tooltip tooltip-left">
                                <h4>Hooded Cape</h4>
                                <p>A weathered traveler's cloak. The mottled brown fabric helps her blend into crowds when she'd rather not be noticed.</p>
                            </div>
                        </div>
                        
                        <div class="hotspot" data-hotspot="hair" style="left: 60%; top: 15%;">
                            <span class="hotspot-pulse"></span>
                            <div class="hotspot-tooltip">
                                <h4>Hair Buns</h4>
                                <p>Practical space buns keep her hair out of the way during delicate work. The ties are thin golden cord, subtle but sturdy.</p>
                            </div>
                        </div>
                        
                        <div class="hotspot" data-hotspot="apron" style="left: 14.5%; top: 34%;">
                            <span class="hotspot-pulse"></span>
                            <div class="hotspot-tooltip">
                                <h4>Work Apron</h4>
                                <p>A faded rose-colored apron, stained with tinctures and herb residue. The fabric is worn thin at the edges from countless washings.</p>
                            </div>
                        </div>
                        
                        <div class="hotspot" data-hotspot="constellation" style="left: 58.5%; top: 46%;">
                            <span class="hotspot-pulse hotspot-pulse-mystery"></span>
                            <div class="hotspot-tooltip">
                                <h4>Constellation Mark</h4>
                                <p>A cluster of pale scars just above her wrist. It looks like an old chemical burn, but the pattern seems oddly deliberate.</p>
                            </div>
                        </div>
                        
                        <div class="hotspot" data-hotspot="boots" style="left: 36%; top: 81%;">
                            <span class="hotspot-pulse"></span>
                            <div class="hotspot-tooltip">
                                <h4>Boots</h4>
                                <p>Sturdy leather boots with reinforced soles. Made for standing long hours at a workbench, but practical enough for the docks.</p>
                            </div>
                        </div>
                    </div>
                </section>

                </div>

            <!-- Medicine Page -->
            <div class="page" id="medicine-page">
                <header class="page-header page-header-hero" style="background-image: url('img/scene.png');">
                    <div class="page-header-overlay">
                        <h1 class="page-title">Meilin's Apothecary</h1>
                        <p class="page-subtitle">Herbal Medicine Quick Reference</p>
                    </div>
                </header>

                <!-- Quick Rules Reference (Collapsible) -->
                <section class="quick-rules">
                    <details>
                        <summary class="rules-toggle">
                            <span class="rules-icon"><i data-lucide="scroll"></i></span>
                            Quick Rules Reference
                        </summary>
                        <div class="rules-content" id="rules-content">
                            <!-- Will be populated by JS -->
                        </div>
                    </details>
                </section>

                <!-- How to Harvest (Collapsible) -->
                <section class="quick-rules">
                    <details>
                        <summary class="rules-toggle">
                            <span class="rules-icon"><i data-lucide="axe"></i></span>
                            How to Harvest
                        </summary>
                        <div class="rules-content" id="harvesting-content">
                            <!-- Will be populated by JS -->
                        </div>
                    </details>
                </section>

                <!-- Tab Navigation -->
                <nav class="tab-nav">
                    <button class="tab-btn active" data-tab="ingredients">Ingredients</button>
                    <button class="tab-btn" data-tab="medicines">Medicines</button>
                    <button class="tab-btn" data-tab="craft">Craft</button>
                    <button class="tab-btn" data-tab="potionrules">Rules</button>
                </nav>

                <!-- Main Content -->
                <main class="main-content">
                    <!-- Medicines Grid -->
                    <div class="tab-content" id="medicines-tab">
                        <!-- Search and Filters -->
                        <section class="search-section">
                            <div class="filter-controls">
                                <div class="filter-group">
                                    <label for="sort-filter">Sort:</label>
                                    <select id="sort-filter">
                                        <option value="name">Name</option>
                                        <option value="category">Category</option>
                                        <option value="difficulty">Difficulty</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="category-filter">Category:</label>
                                    <select id="category-filter">
                                        <option value="all">All Categories</option>
                                        <option value="Augmenting">Augmenting</option>
                                        <option value="Curative">Curative</option>
                                        <option value="Fortifying">Fortifying</option>
                                        <option value="Restorative">Restorative</option>
                                        <option value="Special">Special</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="difficulty-filter">Difficulty:</label>
                                    <select id="difficulty-filter">
                                        <option value="all">All Difficulties</option>
                                        <option value="1">â˜… (DC 10)</option>
                                        <option value="2">â˜…â˜… (DC 15)</option>
                                        <option value="3">â˜…â˜…â˜… (DC 20)</option>
                                        <option value="4">â˜…â˜…â˜…â˜… (DC 25)</option>
                                        <option value="5">â˜…â˜…â˜…â˜…â˜… (DC 28)</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="ingredient-type-filter">Ingredients:</label>
                                    <select id="ingredient-type-filter">
                                        <option value="all">All Types</option>
                                        <option value="flora">Flora</option>
                                        <option value="creature">Creature</option>
                                    </select>
                                </div>
                            </div>
                            <div class="search-bar">
                                <input type="text" id="search-input" placeholder="Search medicines..." autocomplete="off">
                                <button class="clear-search" id="clear-search" title="Clear search">Ã—</button>
                            </div>
                        </section>
                        <div class="medicine-count" id="medicine-count"></div>
                        <div class="medicine-grid" id="medicine-grid">
                            <!-- Medicine cards will be populated by JS -->
                        </div>
                    </div>

                    <!-- Ingredients Reference -->
                    <div class="tab-content active" id="ingredients-tab">
                        <div class="ingredients-section" id="ingredients-section">
                            <!-- Ingredient tables will be populated by JS -->
                        </div>
                    </div>

                    <!-- Potion Rules Reference -->
                    <div class="tab-content" id="potionrules-tab">
                        <div class="potion-rules-section" id="potion-rules-section">
                            <!-- Potion rules will be populated by JS -->
                        </div>
                    </div>

                    <!-- Craft Tab -->
                    <div class="tab-content" id="craft-tab">
                        <section class="craft-section">
                            <div class="craft-layout">
                                <!-- Ingredient Inventory Panel -->
                                <aside class="craft-inventory">
                                    <h3 class="inventory-title">Your Ingredients</h3>
                                    <div class="inventory-sections" id="inventory-sections">
                                        <!-- Populated by JS -->
                                    </div>
                                    <div class="inventory-actions">
                                        <button class="clear-inventory-btn" id="clear-inventory">Clear All</button>
                                        <div class="inventory-io">
                                            <button class="io-btn export-btn" id="export-inventory" title="Download inventory as JSON">
                                                <i data-lucide="download"></i> Export
                                            </button>
                                            <label class="io-btn import-btn" title="Load inventory from JSON file">
                                                <i data-lucide="upload"></i> Import
                                                <input type="file" id="import-inventory" accept=".json" hidden>
                                            </label>
                                        </div>
                                    </div>
                                </aside>
                                
                                <!-- Craftable Medicines Panel -->
                                <main class="craft-results">
                                    <div class="results-header">
                                        <h3 class="results-title">Craftable Medicines</h3>
                                        <span class="results-count" id="craftable-count">0 medicines</span>
                                    </div>
                                    <div class="craftable-grid" id="craftable-grid">
                                        <p class="empty-state">Add ingredients to see what you can craft...</p>
                                    </div>
                                </main>
                            </div>
                        </section>
                    </div>
                </main>

                <!-- Medicine Detail Modal -->
                <div class="modal-overlay" id="modal-overlay">
                    <div class="modal" id="medicine-modal">
                        <button class="modal-close" id="modal-close">Ã—</button>
                        <div class="modal-content" id="modal-content">
                            <!-- Modal content populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Craft Options Modal -->
                <div class="modal-overlay" id="craft-modal-overlay">
                    <div class="modal craft-modal">
                        <button class="modal-close" id="craft-modal-close">Ã—</button>
                        <div class="craft-modal-content" id="craft-modal-content">
                            <!-- Populated by JS: medicine info, alternative selection, 
                                 enhancement options, confirm/cancel buttons -->
                        </div>
                    </div>
                </div>

                <!-- Footer (Medicine page only) -->
                <footer class="footer">
                    <p class="footer-credit">Based on the Alchemy Almanac system</p>
                </footer>
            </div>

            <!-- Backstory Page -->
            <div class="page" id="backstory-page">
                <header class="page-header page-header-hero" style="background-image: url('img/key_art.png');">
                    <div class="page-header-overlay">
                        <h1 class="page-title">The Story of Meilin Starwell</h1>
                        <p class="page-subtitle">A dock-born apothecary who learned that cures are politics</p>
                    </div>
                </header>

                <!-- Backstory Content (Single Scrollable Page) -->
                <main class="backstory-content">
                    <!-- Backstory Chapters -->
                    <div class="backstory-enhanced" id="backstory-enhanced">
                        <div class="loading-spinner">Loading backstory...</div>
                    </div>

                    <!-- Vignettes Section (After Backstory) -->
                    <section class="vignettes-section" id="vignettes-section">
                        <div class="section-divider">
                            <span class="divider-text">After the Backstory</span>
                        </div>
                        <div class="vignettes-intro">
                            <h2 class="vignettes-title">Vignettes</h2>
                            <p class="vignettes-note">These vignettes take place <strong>after</strong> Meilin's backstory, during her time at the Astral Bazaar. Each captures a small moment that reveals her skills, habits, and way of seeing the world.</p>
                        </div>
                        <div class="vignettes-grid" id="vignettes-grid">
                            <div class="loading-spinner">Loading vignettes...</div>
                        </div>
                    </section>
                </main>

                <!-- Vignette Detail Modal -->
                <div class="modal-overlay" id="vignette-modal-overlay">
                    <div class="modal vignette-modal">
                        <button class="modal-close" id="vignette-modal-close">Ã—</button>
                        <div class="modal-content" id="vignette-modal-content">
                            <!-- Vignette content populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- DM Tools Page -->
            <div class="page" id="dmtools-page">
                <header class="page-header">
                    <h1 class="page-title">DM Tools</h1>
                    <p class="page-subtitle">Hooks, relationships, and handles for running Meilin</p>
                </header>

                <!-- DM Tools Tab Navigation -->
                <nav class="dmtools-tabs">
                    <button class="dmtools-tab active" data-dmtab="relationships">
                        <span class="dmtools-tab-icon"><i data-lucide="link"></i></span>
                        <span class="dmtools-tab-text">Relationships</span>
                    </button>
                    <button class="dmtools-tab" data-dmtab="knives">
                        <span class="dmtools-tab-icon"><i data-lucide="sword"></i></span>
                        <span class="dmtools-tab-text">Knives</span>
                    </button>
                    <button class="dmtools-tab" data-dmtab="mindersand">
                        <span class="dmtools-tab-icon"><i data-lucide="flask-conical"></i></span>
                        <span class="dmtools-tab-text">Mindersand</span>
                    </button>
                    <button class="dmtools-tab" data-dmtab="medica">
                        <span class="dmtools-tab-icon"><i data-lucide="heart-pulse"></i></span>
                        <span class="dmtools-tab-text">The Medica</span>
                    </button>
                </nav>

                <main class="dmtools-content">
                    <!-- Relationships Tab Panel -->
                    <section class="dmtools-panel active" id="relationships-panel">
                        <div class="dmtools-panel-header">
                            <h2 class="dmtools-panel-title">Relationships</h2>
                            <p class="dmtools-panel-subtitle">A visual map of Meilin's connections, tensions, and the pressure points between them.</p>
                        </div>
                        <div class="relationships-map" id="relationships-map">
                            <div class="loading-spinner">Loading relationships...</div>
                        </div>
                    </section>

                    <!-- Knives Tab Panel -->
                    <section class="dmtools-panel" id="knives-panel">
                        <div class="dmtools-panel-header">
                            <h2 class="dmtools-panel-title">Knives</h2>
                            <p class="dmtools-panel-subtitle"><strong>Knives</strong> are specific, actionable things the DM can use to create drama. Each one is a handle to pull Meilin into the story.</p>
                        </div>
                        <div class="knives-grid" id="knives-grid">
                            <div class="loading-spinner">Loading knives...</div>
                        </div>
                    </section>

                    <!-- Mindersand Tab Panel -->
                    <section class="dmtools-panel" id="mindersand-panel">
                        <div class="dmtools-panel-header">
                            <h2 class="dmtools-panel-title">Mindersand Reference</h2>
                            <p class="dmtools-panel-subtitle">The contraband powder at the heart of Meilin's story. Use this reference to describe its effects, trace its routes, and build encounters around it.</p>
                        </div>
                        <div class="mindersand-content" id="mindersand-content">
                            <div class="loading-spinner">Loading mindersand data...</div>
                        </div>
                    </section>

                    <!-- Medica Tab Panel -->
                    <section class="dmtools-panel" id="medica-panel">
                        <div class="dmtools-panel-header">
                            <h2 class="dmtools-panel-title">The Medica</h2>
                            <p class="dmtools-panel-subtitle">Use this reference to understand guild mechanics, rank progression, and how to integrate the Medica into your campaign.</p>
                        </div>
                        <div class="medica-content" id="medica-content">
                            <div class="loading-spinner">Loading Medica data...</div>
                        </div>
                    </section>
                </main>

                <!-- NPC Detail Modal -->
                <div class="modal-overlay" id="npc-modal-overlay">
                    <div class="modal npc-modal">
                        <button class="modal-close" id="npc-modal-close">Ã—</button>
                        <div class="modal-content" id="npc-modal-content">
                            <!-- NPC content populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Knife Detail Modal -->
                <div class="modal-overlay" id="knife-modal-overlay">
                    <div class="modal knife-modal">
                        <button class="modal-close" id="knife-modal-close">Ã—</button>
                        <div class="modal-content" id="knife-modal-content">
                            <!-- Knife content populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Passkey Modal -->
    <div class="modal-overlay" id="passkey-modal-overlay">
        <div class="modal passkey-modal">
            <div class="passkey-content">
                <h2 class="passkey-title">ðŸ”’ Meilin's Companion</h2>
                <p class="passkey-subtitle">Enter the passkey to access this reference.</p>
                <form id="passkey-form">
                    <input type="password" id="passkey-input" class="passkey-input" placeholder="Enter passkey..." autocomplete="off">
                    <p class="passkey-error" id="passkey-error"></p>
                    <div class="passkey-buttons">
                        <button type="button" class="passkey-cancel" id="passkey-cancel">Go Back</button>
                        <button type="submit" class="passkey-submit">Unlock</button>
                    </div>
                </form>
                <p class="passkey-hint">Hint: The code for mindersand in Smith's Coster's ledger.</p>
            </div>
        </div>
    </div>

    <!-- Global Image Lightbox Modal -->
    <div class="lightbox-overlay" id="global-lightbox">
        <button class="lightbox-close" id="lightbox-close">&times;</button>
        <img class="lightbox-image" id="lightbox-image" src="" alt="Enlarged view" />
    </div>

    <!-- HTML Templates for JS-rendered content -->
    
    <!-- Medicine Card Template -->
    <template id="medicine-card-template">
        <div class="medicine-card" data-id="" data-category="">
            <div class="medicine-ingredient-badges"></div>
            <div class="medicine-card-header">
                <h3 class="medicine-name"></h3>
                <span class="medicine-stars"></span>
            </div>
            <div class="medicine-meta">
                <span class="medicine-category"></span>
                <span class="medicine-dc"></span>
            </div>
            <p class="medicine-preview"></p>
        </div>
    </template>
    
    <!-- Knife Card Template -->
    <template id="knife-card-template">
        <div class="knife-card" data-knife-index="">
            <div class="knife-card-header">
                <span class="knife-card-icon"><i data-lucide=""></i></span>
                <h3 class="knife-card-name"></h3>
            </div>
            <span class="knife-card-type"></span>
            <p class="knife-card-summary"></p>
        </div>
    </template>
    
    <!-- Rumor Item Template -->
    <template id="rumor-item-template">
        <div class="rumor-item" data-image="">
            <span class="rumor-text">
                <span class="rumor-readable"></span>
                <span class="rumor-cipher" aria-hidden="true"></span>
            </span>
        </div>
    </template>
    
    <!-- Relationship Card Template -->
    <template id="relationship-card-template">
        <div class="relationship-card" data-connection-name="">
            <h4 class="relationship-card-name"></h4>
            <span class="relationship-card-type"></span>
            <p class="relationship-card-role"></p>
            <p class="relationship-card-tension"></p>
            <p class="relationship-card-location"></p>
        </div>
    </template>
    
    <!-- Vignette Card Template -->
    <template id="vignette-card-template">
        <div class="vignette-card" data-vignette-index="">
            <div class="vignette-number"></div>
            <h3 class="vignette-title"></h3>
            <div class="vignette-skills"></div>
            <p class="vignette-preview"></p>
            <span class="vignette-read-more">Read more â†’</span>
        </div>
    </template>
    
    <!-- Backstory Section Template -->
    <template id="backstory-section-template">
        <section class="backstory-section" data-chapter-index="">
            <div class="backstory-section-header" role="button" tabindex="0">
                <span class="backstory-section-icon"><i data-lucide=""></i></span>
                <h2 class="backstory-section-title"></h2>
                <span class="chapter-badge"></span>
                <span class="expand-indicator">â–¼</span>
            </div>
            <blockquote class="backstory-quote"></blockquote>
            <div class="backstory-section-content"></div>
            <div class="chapter-content-expanded">
                <div class="chapter-loading">Loading chapter...</div>
            </div>
        </section>
    </template>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- ES Module Application -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Mobile Drawer Fallback (inline for immediate availability) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('drawer-overlay');
            
            if (hamburgerBtn && sidebar) {
                hamburgerBtn.addEventListener('click', function() {
                    const isOpen = sidebar.classList.contains('open');
                    if (isOpen) {
                        sidebar.classList.remove('open');
                        if (overlay) overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    } else {
                        sidebar.classList.add('open');
                        if (overlay) overlay.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    }
                });
                
                if (overlay) {
                    overlay.addEventListener('click', function() {
                        sidebar.classList.remove('open');
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
            }
        });
    </script>
</body>
</html>
